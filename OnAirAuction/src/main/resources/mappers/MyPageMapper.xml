<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.kr.OnAirAuction.DAO.MyPageDAO">

	<!-- 경매 참가 내역 조회 쿼리 -->

	<select id="selectPartAuctList" resultType="kr.kr.OnAirAuction.VO.ParticipateAuctionVO">
	
		select ac_num, ac_ac_name, me_name, pr_name, pr_startprice, ac_startDate, ac_state, ar_bidprice
		
		from auction join member on ac_me_id = me_id join product on pr_code = ac_pr_code
		
		join auction_record on ac_num = ar_ac_num
		
		where (pr_name like concat('%', #{criteria.search}, '%') or me_name like concat('%', #{criteria.search}, '%'))
		
		<if test="criteria.fromDate != null and criteria.toDate != null">and ac_startDate between #{criteria.fromDate} and #{criteria.toDate}</if>
		
		order by ac_num asc limit #{criteria.pageStart}, #{criteria.perPageNum}
	
	</select>
	
	<!-- 경매 개최 내역 관련 쿼리 -->
	
	<select id="selectPartAuctTotalCount" resultType="int">
	
		select count(*)
		
		from auction join member on ac_me_id = me_id join product on pr_code = ac_pr_code
		
		join auction_record on ac_num = ar_ac_num
	
	</select>
	
	<!-- 경매 참가 내역 조회 쿼리 -->
	
	<select id="selectHeldAuctList" resultType="kr.kr.OnAirAuction.VO.HeldAuctionVO">
	
		select ac_num, pr_name, pr_startprice, ac_startdate, ac_finaldate, ac_state, ac_immediate
		
		from auction join product on ac_pr_code = pr_code
		
		where (pr_name like concat('%', #{criteria.search}, '%'))
		
		<if test="criteria.fromDate != null and criteria.toDate != null">and ac_startDate between #{criteria.fromDate} and #{criteria.toDate}</if>
		
		 order by ac_num asc limit #{criteria.pageStart}, #{criteria.perPageNum}
	
	</select>
	
	<select id="selectHeldAuctTotalCount" resultType="int">
	
		select count(*)
		
		from auction join product on ac_pr_code = pr_code
	
	</select>
	
	<select id="selectHeldList" resultType="kr.kr.OnAirAuction.VO.AuctionCancleVO">

		select * from auction_cancle where ac_ac_num = #{ac_num}

	</select>
	
	<insert id="insertAuctionCancle">
  	
  		insert into auction_cancel(ac_num, ac_date, ac_reason, ac_ac_num)
  			
  		select ifnull(max(ac_num), 0) + 1, now(), #{auctionCancle.ac_reason}, #{auctionCancle.ac_ac_num}
		
  		from auction_cancel
  		
  	</insert>
  	
  	<!-- 후기 등록 -->
  	
  	<insert id="insertReview" useGeneratedKeys="true" keyProperty="review.re_num">
  	
  		insert into review(re_num, re_title, re_content, re_level)
  		
  		select ifnull(max(re_num),0)+1, #{review.re_title}, #{review.re_content}, #{review.re_level}
  		
  		from review
  	
  	</insert>
  	
  	<select id="selectAuction" resultType="kr.kr.OnAirAuction.VO.ParticipateAuctionVO">
  	
  		select ar_num from auction_record where ar_num = #{re_ar_num} 
  		
  	</select>
  	
  	<!-- 첨부 파일 -->
  	
  	<insert id="insertFile">
  	
  		insert into file(fi_name, fi_savename)
  		
  		values(#{fileVO.fi_name},#{fileVO.fi_savename})
  	
  	</insert>
  	
  	<!-- 후기 조회 -->
  	
  	<select id="selectReviewList" resultType="kr.kr.OnAirAuction.VO.ReviewVO">
  		
  		select * from Review order by re_num desc limit #{criteria.pageStart}, #{criteria.perPageNum}
  		
  	</select>

</mapper>